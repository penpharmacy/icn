<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IC Hand Hygiene Audit - โรงพยาบาลพุนพิน</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; color: #333; }
        .header-banner { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; padding: 30px; border-radius: 0 0 25px 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .section-title { border-left: 6px solid #11998e; padding-left: 15px; margin-bottom: 25px; color: #11998e; font-weight: bold; font-size: 1.2rem; }
        .dash-card { background: white; border-radius: 15px; padding: 25px; text-align: center; border-bottom: 4px solid #11998e; height: 100%; }
        .dash-title { font-size: 0.85rem; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; font-weight: bold; }
        .dash-value { font-size: 1.5rem; font-weight: 800; color: #2c3e50; }
        .radio-group-box { background: #fafafa; padding: 18px; border-radius: 12px; border: 1px solid #eee; height: 100%; }
        .other-input { display: none; margin-top: 10px; border-color: #11998e; }
        .btn-check:checked + .btn-outline-primary { background-color: #0d6efd; color: white; }
        .btn-check:checked + .btn-outline-info { background-color: #0dcaf0; color: white; }
        .btn-check:checked + .btn-outline-danger { background-color: #dc3545; color: white; }
        .btn-check:checked + .btn-outline-secondary { background-color: #6c757d; color: white; }
        @media print { .no-print { display: none !important; } .card { box-shadow: none; border: 1px solid #eee; } }

        /* เพิ่มส่วนการซ่อน Report เริ่มต้น */
        #main-report-container { display: none; }
    </style>
</head>
<body>

<div class="header-banner text-center mb-4 no-print">
    <h2 class="fw-bold"><i class="fas fa-hands-wash"></i> Hand Hygiene Audit</h2>
    <p class="mb-0 opacity-75">โปรแกรมบันทึกการล้างมือ - โรงพยาบาลพุนพิน</p>
</div>

<div class="container-fluid px-lg-5">
    <div class="card p-4 no-print">
        <h5 class="section-title"><i class="fas fa-edit"></i> บันทึกผลการสังเกตการณ์</h5>
        <div class="row g-3 mb-4">
            <div class="col-md-3"><label class="form-label fw-bold">วันที่สังเกต</label><input type="date" id="obsDate" class="form-control form-control-lg"></div>
            <div class="col-md-2"><label class="form-label fw-bold">เวลา</label><input type="time" id="obsTime" class="form-control form-control-lg"></div>
        </div>
        
        <div class="row g-4">
            <div class="col-md-3">
                <label class="form-label fw-bold text-primary">1. แผนก</label>
                <div class="radio-group-box">
                    <div class="form-check mb-2"><input class="form-check-input" type="radio" name="deptRadio" value="OPD" id="d_opd"><label class="form-check-label" for="d_opd">OPD</label></div>
                    <div class="form-check mb-2"><input class="form-check-input" type="radio" name="deptRadio" value="IPD" id="d_ipd"><label class="form-check-label" for="d_ipd">IPD</label></div>
                    <div class="form-check mb-2"><input class="form-check-input" type="radio" name="deptRadio" value="LR" id="d_lr"><label class="form-check-label" for="d_lr">LR</label></div>
                    <div class="form-check mb-2"><input class="form-check-input" type="radio" name="deptRadio" value="ER" id="d_er"><label class="form-check-label" for="d_er">ER</label></div>
                    <div class="form-check mb-2"><input class="form-check-input" type="radio" name="deptRadio" value="อื่นๆ" id="d_other" onclick="toggleOther('deptOther', true)"><label class="form-check-label" for="d_other">อื่นๆ</label></div>
                    <input type="text" id="deptOther" class="form-control form-control-sm other-input" placeholder="ระบุชื่อแผนก...">
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold text-primary">2. วิชาชีพ</label>
                <div class="radio-group-box">
                    <div class="form-check mb-2"><input class="form-check-input" type="radio" name="roleRadio" value="แพทย์" id="r_dr"><label class="form-check-label" for="r_dr">แพทย์</label></div>
                    <div class="form-check mb-2"><input class="form-check-input" type="radio" name="roleRadio" value="พยาบาล" id="r_ns"><label class="form-check-label" for="r_ns">พยาบาล</label></div>
                    <div class="form-check mb-2"><input class="form-check-input" type="radio" name="roleRadio" value="ผู้ช่วยเหลือคนไข้" id="r_na"><label class="form-check-label" for="r_na">ผู้ช่วยเหลือคนไข้</label></div>
                    <div class="form-check mb-2"><input class="form-check-input" type="radio" name="roleRadio" value="นักศึกษาพยาบาล" id="r_st"><label class="form-check-label" for="r_st">นักศึกษาพยาบาล</label></div>
                    <div class="form-check mb-2"><input class="form-check-input" type="radio" name="roleRadio" value="อื่นๆ" id="r_other" onclick="toggleOther('roleOther', true)"><label class="form-check-label" for="r_other">อื่นๆ</label></div>
                    <input type="text" id="roleOther" class="form-control form-control-sm other-input" placeholder="ระบุวิชาชีพ...">
                </div>
            </div>
            <div class="col-md-6 border-start ps-4">
                <label class="form-label fw-bold text-warning">3. ความพร้อมอุปกรณ์สนับสนุนการล้างมือ</label>
                <div class="row bg-light p-3 rounded-3">
                    <div class="col-6">
                        <div class="form-check mb-2"><input class="form-check-input equip" type="checkbox" id="e0"><label class="small">อ่างล้างมือ</label></div>
                        <div class="form-check mb-2"><input class="form-check-input equip" type="checkbox" id="e1"><label class="small">สบู่เหลว</label></div>
                        <div class="form-check mb-2"><input class="form-check-input equip" type="checkbox" id="e2"><label class="small">4% Chlorhexidine</label></div>
                        <div class="form-check mb-2"><input class="form-check-input equip" type="checkbox" id="e3"><label class="small">Alcohol hand rub</label></div>
                    </div>
                    <div class="col-6">
                        <div class="form-check mb-2"><input class="form-check-input equip" type="checkbox" id="e4"><label class="small">กระดาษเช็ดมือ</label></div>
                        <div class="form-check mb-2"><input class="form-check-input equip" type="checkbox" id="e5"><label class="small">โปสเตอร์สอนล้างมือ</label></div>
                        <div class="form-check mb-2"><input class="form-check-input equip" type="checkbox" id="e6"><label class="small">ถังขยะทิ้งกระดาษเช็ดมือ</label></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4 border-top pt-4">
            <h6 class="fw-bold mb-3 text-success">4. การปฏิบัติ 5 Moments</h6>
            <div id="momentInputList" class="row g-3"></div>
        </div>

        <div class="text-end mt-4">
            <button class="btn btn-light border px-4 me-2" onclick="clearForm()">ล้างฟอร์ม</button>
            <button class="btn btn-success btn-lg px-5 shadow" onclick="saveData()"><i class="fas fa-save me-2"></i> บันทึกข้อมูล</button>
        </div>
    </div>

    <div id="main-report-container">
        <div class="row g-3 mb-4">
            <div class="col-md-2">
                <div class="dash-card">
                    <div class="dash-title">สัดส่วนทำความสะอาดมือด้วยน้ำสบู่</div>
                    <div class="dash-value" id="hw_total">0.0% (0/0)</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="dash-card">
                    <div class="dash-title">สัดส่วนทำความสะอาดมือด้วยHR</div>
                    <div class="dash-value" id="hr_total">0.0% (0/0)</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="dash-card" style="border-bottom-color: #28a745;">
                    <div class="dash-title text-success">อัตราการทำความสะอาดมือภาพรวม</div>
                    <div class="dash-value text-success" id="comp_rate">0.0% (0/0)</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="dash-card" style="border-bottom-color: #ffc107;">
                    <div class="dash-title text-warning">อุปกรณ์พร้อมใช้</div>
                    <div class="dash-value text-warning" id="equip_rate">0.0% (0/0)</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="dash-card" style="border-bottom-color: #0d6efd;">
                    <div class="dash-title text-primary">สัดส่วนการทำความสะอาดมือ(ครั้ง)</div>
                    <div style="height: 120px;"><canvas id="cleanPieChart"></canvas></div>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-lg-6">
                <div class="card p-4 h-100">
                    <h5 class="section-title">อัตราทำความสะอาดมือแต่ละโอกาส 5 Moments (HR+HW) (%)</h5>
                    <div style="height: 350px;"><canvas id="momentChart"></canvas></div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card p-4 h-100">
                    <h5 class="section-title">อัตราการทำความสะอาดมือแต่ละโอกาส แยกราย Moment</h5>
                    <div class="table-responsive">
                        <table class="table table-hover table-bordered text-center align-middle" style="font-size: 0.9rem;">
                            <thead class="table-light">
                                <tr>
                                    <th class="text-start">Moment</th>
                                    <th class="table-success">HW+HR</th>
                                    <th>HW</th>
                                    <th>HR</th>
                                    <th>ไม่ล้างมือ</th>
                                    <th>สวมถุงมือ</th>
                                </tr>
                            </thead>
                            <tbody id="momentTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-end mb-4 no-print">
            <button class="btn btn-outline-success me-2" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Export Excel</button>
            <button class="btn btn-outline-dark" onclick="window.print()"><i class="fas fa-print"></i> พิมพ์รายงาน</button>
        </div>

        <div id="reportArea">
            <div class="row">
                <div class="col-md-6">
                    <div class="card p-4">
                        <h5 class="section-title">อัตราการทำความสะอาดมือแยกตามแผนก</h5>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered text-center align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>แผนก</th>
                                        <th class="table-success">HW+HR</th>
                                        <th>HW</th>
                                        <th>HR</th>
                                        <th>ไม่ล้างมือ</th>
                                        <th>สวมถุงมือ</th>
                                    </tr>
                                </thead>
                                <tbody id="deptTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card p-4">
                        <h5 class="section-title">อัตราการทำความสะอาดมือแยกตามวิชาชีพ</h5>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered text-center align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>วิชาชีพ</th>
                                        <th class="table-success">HW+HR</th>
                                        <th>HW</th>
                                        <th>HR</th>
                                        <th>ไม่ล้างมือ</th>
                                        <th>สวมถุงมือ</th>
                                    </tr>
                                </thead>
                                <tbody id="roleTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card p-4">
                <h5 class="section-title">ความพร้อมอุปกรณ์แยกตามแผนก (%)</h5>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered text-center align-middle">
                        <thead class="small table-light">
                            <tr>
                                <th>แผนก</th>
                                <th>อ่างล้างมือ</th><th>สบู่เหลว</th><th>4%CHG</th><th>Alcohol hand rub</th><th>กระดาษเช็ดมือ</th><th>โปสเตอร์</th><th>ถังขยะทิ้งกระดาษเช็ดมือ</th>
                            </tr>
                        </thead>
                        <tbody id="equipDeptTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzBrC7afQChoOR2RrSWUQXoX3B0pSkj-Vrrt0OIUSSd_Ms4YsLzPXUI5lvjm0QohtmD4w/exec"; 
    const momentLabels = ["ก่อนสัมผัสผู้ป่วย", "ก่อนทำหัตถการปลอดเชื้อ", "หลังสัมผัสสารคัดหลั่งผู้ป่วย", "หลังสัมผัสผู้ป่วย", "หลังสัมผัสสิ่งรอบตัวผู้ป่วย"];
    let database = [];
    let momentChart = null;
    let cleanPieChart = null;

    window.onload = function() {
        const mDiv = document.getElementById('momentInputList');
        momentLabels.forEach((label, i) => {
            mDiv.innerHTML += `
            <div class="col-md-4">
                <div class="p-3 border rounded-3 bg-white">
                    <label class="small fw-bold d-block mb-2 text-dark">${i+1}. ${label}</label>
                    <div class="d-flex flex-wrap gap-2">
                        <input type="radio" class="btn-check" name="m${i}" id="m${i}hw" value="HW"><label class="btn btn-outline-primary btn-sm px-3" for="m${i}hw">HW</label>
                        <input type="radio" class="btn-check" name="m${i}" id="m${i}hr" value="HR"><label class="btn btn-outline-info btn-sm px-3" for="m${i}hr">HR</label>
                        <input type="radio" class="btn-check" name="m${i}" id="m${i}no" value="None"><label class="btn btn-outline-danger btn-sm px-2" for="m${i}no">ไม่ล้างมือ</label>
                        <input type="radio" class="btn-check" name="m${i}" id="m${i}gl" value="Glove"><label class="btn btn-outline-secondary btn-sm px-2" for="m${i}gl">สวมถุงมือ</label>
                    </div>
                </div>
            </div>`;
        });
        initCharts();
        fetch(SCRIPT_URL).then(res => res.json()).then(data => { database = data; render(database); }).catch(err => render(database));
    };

    function initCharts() {
        const ctxBar = document.getElementById('momentChart').getContext('2d');
        momentChart = new Chart(ctxBar, {
            type: 'bar',
            data: { labels: ["M1", "M2", "M3", "M4", "M5"], datasets: [{ label: 'HW+HR (%)', data: [0,0,0,0,0], backgroundColor: '#11998e', borderRadius: 5 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false } } }
        });

        const ctxPie = document.getElementById('cleanPieChart').getContext('2d');
        cleanPieChart = new Chart(ctxPie, {
            type: 'pie',
            data: { labels: ['HW', 'HR', 'ไม่ล้างมือ', 'สวมถุงมือ'], datasets: [{ data: [0, 0, 0, 0], backgroundColor: ['#0d6efd', '#0dcaf0', '#dc3545', '#6c757d'] }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 9 } } } } }
        });
    }

    function toggleOther(id, show) { document.getElementById(id).style.display = show ? "block" : "none"; }
    function clearForm() { 
        document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false); 
        document.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = false); 
        document.getElementById('obsDate').value = ""; document.getElementById('obsTime').value = "";
        toggleOther('deptOther', false);
        toggleOther('roleOther', false);
    }

    function saveData() {
        const dDate = document.getElementById('obsDate').value;
        const dTime = document.getElementById('obsTime').value;
        const dRadio = document.querySelector('input[name="deptRadio"]:checked');
        const rRadio = document.querySelector('input[name="roleRadio"]:checked');
        if (!dDate || !dTime || !dRadio || !rRadio) return alert("กรุณากรอกข้อมูลให้ครบ");
        
        let dVal = dRadio.value === "อื่นๆ" ? (document.getElementById('deptOther').value || "อื่นๆ") : dRadio.value;
        let rVal = rRadio.value === "อื่นๆ" ? (document.getElementById('roleOther').value || "อื่นๆ") : rRadio.value;
        
        const moments = [0,1,2,3,4].map(i => {
            const el = document.querySelector(`input[name="m${i}"]:checked`);
            return el ? el.value : ""; 
        });

        const record = { obsDate: dDate, obsTime: dTime, dept: dVal, role: rVal, m: moments, equips: Array.from(document.querySelectorAll('.equip')).map(e => e.checked ? 1 : 0) };
        fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(record) });
        database.push(record); render(database); alert("บันทึกข้อมูลเรียบร้อยแล้ว"); clearForm();
    }

    const formatVal = (count, total, isInteger = false) => {
        let pct = (total === 0) ? 0 : (count / total) * 100;
        let textColor = pct === 0 ? '#dc3545' : (pct === 100 ? '#198754' : '#333');
        let displayPct = isInteger ? pct.toFixed(0) : pct.toFixed(1);
        return `<span style="color: ${textColor}; font-weight: bold;">${displayPct}%</span><br><small class='text-muted'>(${count}/${total})</small>`;
    };

    function render(data) {
        let n_records = data.length; 
        
        // --- ส่วนที่เพิ่มเพื่อควบคุมการแสดงผลตามเงื่อนไข ---
        const container = document.getElementById('main-report-container');
        if(n_records === 0) {
            container.style.display = "none";
            return;
        } else {
            container.style.display = "block";
        }
        // -------------------------------------------

        let hw = 0, hr = 0, none = 0, glove = 0, eq = 0;
        let totalOpp = 0;
        let mComp = [0,0,0,0,0];
        let mTotal = [0,0,0,0,0];

        data.forEach(d => {
            d.m.forEach((v, idx) => { 
                if (v && v !== "Pending" && v !== "") {
                    totalOpp++;
                    mTotal[idx]++;
                    if(v==='HW') { hw++; mComp[idx]++; }
                    else if(v==='HR') { hr++; mComp[idx]++; }
                    else if(v==='None') none++;
                    else if(v==='Glove') glove++;
                }
            });
            d.equips.forEach(v => eq += v);
        });

        const totalHWHR = hw + hr;

        document.getElementById('hw_total').innerText = (totalHWHR > 0 ? ((hw / totalHWHR) * 100).toFixed(1) : "0.0") + `% (${hw}/${totalHWHR})`;
        document.getElementById('hr_total').innerText = (totalHWHR > 0 ? ((hr / totalHWHR) * 100).toFixed(1) : "0.0") + `% (${hr}/${totalHWHR})`;
        document.getElementById('comp_rate').innerText = (totalOpp > 0 ? ((totalHWHR / totalOpp) * 100).toFixed(1) : "0.0") + `% (${totalHWHR}/${totalOpp})`;
        document.getElementById('equip_rate').innerText = ((eq / (n_records * 7)) * 100).toFixed(1) + `% (${eq}/${n_records * 7})`;

        momentChart.data.datasets[0].data = mComp.map((c, i) => mTotal[i] > 0 ? ((c / mTotal[i]) * 100).toFixed(1) : 0);
        momentChart.update();
        cleanPieChart.data.datasets[0].data = [hw, hr, none, glove];
        cleanPieChart.update();

        const mBody = document.getElementById('momentTableBody'); mBody.innerHTML = '';
        momentLabels.forEach((l, idx) => {
            let s = {HW:0, HR:0, None:0, Glove:0};
            data.forEach(d => { if(d.m[idx] && d.m[idx] !== "Pending" && d.m[idx] !== "") s[d.m[idx]]++; });
            let totalM = s.HW + s.HR + s.None + s.Glove;
            mBody.innerHTML += `<tr>
                <td class="text-start fw-bold">${l}</td>
                <td class="table-success fw-bold">${formatVal(s.HW + s.HR, totalM)}</td>
                <td>${formatVal(s.HW, totalM)}</td>
                <td>${formatVal(s.HR, totalM)}</td>
                <td>${formatVal(s.None, totalM)}</td>
                <td>${formatVal(s.Glove, totalM)}</td>
            </tr>`;
        });

        renderTable(data, 'dept', 'deptTableBody');
        renderTable(data, 'role', 'roleTableBody');
        renderEquipTable(data);
    }

    function renderTable(data, field, bodyId) {
        const body = document.getElementById(bodyId); body.innerHTML = '';
        const keys = [...new Set(data.map(d => d[field]))];
        keys.forEach(k => {
            let f = data.filter(d => d[field] === k);
            let s = {HW:0, HR:0, None:0, Glove:0};
            f.forEach(d => d.m.forEach(v => {
                if(v && v !== "Pending" && v !== "" && s[v] !== undefined) s[v]++;
            }));
            let total = s.HW + s.HR + s.None + s.Glove;
            body.innerHTML += `<tr>
                <td>${k}</td>
                <td class="table-success fw-bold">${formatVal(s.HW+s.HR, total)}</td>
                <td>${formatVal(s.HW, total)}</td>
                <td>${formatVal(s.HR, total)}</td>
                <td>${formatVal(s.None, total)}</td>
                <td>${formatVal(s.Glove, total)}</td>
            </tr>`;
        });
    }

    function renderEquipTable(data) {
        const body = document.getElementById('equipDeptTableBody'); body.innerHTML = '';
        const depts = [...new Set(data.map(d => d.dept))];
        depts.forEach(dn => {
            let f = data.filter(d => d.dept === dn);
            let row = `<tr><td class="fw-bold">${dn}</td>`;
            for(let i=0; i<7; i++) row += `<td>${formatVal(f.filter(x => x.equips[i] === 1).length, f.length, true)}</td>`;
            body.innerHTML += row + "</tr>";
        });
    }

    function exportToExcel() {
        if(database.length === 0) return alert("ไม่มีข้อมูล");
        const ws = XLSX.utils.json_to_sheet(database.map(d => ({ "วันที่": d.obsDate, "แผนก": d.dept, "วิชาชีพ": d.role, "M1": d.m[0], "M2": d.m[1], "M3": d.m[2], "M4": d.m[3], "M5": d.m[4] })));
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "AuditData");
        XLSX.writeFile(wb, `IC_Audit_${new Date().toISOString().slice(0,10)}.xlsx`);
    }
</script>
</body>
</html>
